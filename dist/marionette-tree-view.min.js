Marionette.NodeView=Marionette.CompositeView.extend({childViewContainer:".children",className:"node",ui:{toggle:"a[data-toggle=node]",iconCollapse:".icon-collapse",iconExpand:".icon-expand",iconLoading:".icon-loading",iconError:".icon-error",children:".children"},events:{"click @ui.iconExpand":"onExpand","click @ui.iconCollapse":"onCollapse","click @ui.toggle":"onSelect"},modelEvents:{"change:children":"onChangeChildren","delete:children":"onDeleteChildren",error:"onError"},initialize:function(a){var b=[];a=a||{},this.nbChildrenAttrName=a.nbChildrenAttrName?a.nbChildrenAttrName:"nbChildren",this.collectionType=a.collectionType,this.model.get("children")&&(b=_.isArray(this.model.get("children"))?this.model.get("children"):this.model.get("children").models),this.collection=new this.collectionType(b)},childViewOptions:function(){return{collectionType:this.collectionType,nbChildrenAttrName:this.nbChildrenAttrName}},onRender:function(){0===this.model.get(this.nbChildrenAttrName)&&this.ui.iconExpand.addClass("hide")},onRenderCollection:function(){this.ui.iconExpand.addClass("hide"),0!==this.model.get(this.nbChildrenAttrName)&&this.ui.iconCollapse.removeClass("hide"),this.ui.children.removeClass("hide"),this.children.each(function(a){this.bindChildView(a)},this)},bindChildView:function(a){this.listenTo(a,"select",this.onChildSelected),this.listenTo(a,"expand",this.onChildExpand),this.listenTo(a,"collapse",this.onChildCollapse)},onChildSelected:function(a){this.trigger("select",a)},onChildExpand:function(a){this.trigger("expand",a)},onChildCollapse:function(a){this.trigger("collapse",a)},onSelect:function(a){this.select(),a.stopPropagation()},onExpand:function(a){this.expand()&&this.trigger("expand",this.model),a.stopPropagation()},onCollapse:function(a){this.collapse()&&this.trigger("collapse",this.model),a.stopPropagation()},onDeleteChildren:function(){this.collapse()},onError:function(){this.setIconsOnError(),this.isExpanding=!1},onChangeChildren:function(){this.collection.reset(this.model.get("children").models),this.ui.iconExpand.addClass("hide"),this.collection.size()?this.ui.iconCollapse.removeClass("hide"):this.$el.addClass("node-empty"),this.ui.iconLoading.addClass("hide"),this.isExpanding=!1},select:function(){this.trigger("select",this.model),this.$el.addClass("active")},expand:function(){return this.$el.hasClass("node-empty")?!1:(this.setIconsOnExpand(),this.isExpanding=!0)},collapse:function(){return this.$el.hasClass("node-empty")||this.isExpanding?!1:(this.setIconsOnCollapse(),this.collection.reset(),!0)},setIconsOnCollapse:function(){this.ui.toggle.addClass("collapsed").removeClass("expanded"),this.ui.iconCollapse.addClass("hide"),this.ui.iconExpand.removeClass("hide"),this.ui.children.addClass("hide")},setIconsOnExpand:function(){this.ui.iconError.addClass("hide"),this.ui.toggle.removeClass("collapsed").addClass("expanded"),this.ui.iconExpand.addClass("hide"),this.ui.iconLoading.removeClass("hide")},setIconsOnError:function(){this.ui.iconExpand.removeClass("hide"),this.ui.iconError.removeClass("hide"),this.ui.iconLoading.addClass("hide"),this.ui.toggle.addClass("collapsed").removeClass("expanded")}}),Marionette.TreeView=Marionette.CollectionView.extend({className:"tree-view",initialize:function(a){a=a||{},this.collectionType=a.collectionType,this.nbChildrenAttrName=a.nbChildrenAttrName},childViewOptions:function(){return{collectionType:this.collectionType,nbChildrenAttrName:this.nbChildrenAttrName}},onShow:function(){this.children.first().select()},_addChildView:function(a,b){Marionette.CollectionView.prototype._addChildView.apply(this,arguments),this.bindChildView(a)},bindChildView:function(a){this.listenTo(a,"select",this.onChildSelected),this.listenTo(a,"expand",this.onChildExpanded),this.listenTo(a,"collapse",this.onChildCollapsed)},onChildSelected:function(a){this.$(".node").removeClass("active"),this.trigger("select",a)},onChildExpanded:function(a){this.trigger("expand",a)},onChildCollapsed:function(a){this.trigger("collapse",a)}});